const index = ["-","Adriatic","Amtrak","Aussichtslosigkeit","Beklommenheit","Bras√≠lia","CPU","Chillon","Congregationalist","Dionysian","Eden","Erse","Fabian","GCE","Giza","HST","Hibernia","Israelites","KO","LOL","Lizzy","Majorca","Mendelevium","Morse","Nepalese","OCR","PG","Romanian","Saipan","September","Spanish-inspired","TTY","Titian","Trappist","Ulyanov","Unico","Western-centeredness","Yemen","abastecido","abgedichtet","abnormal","abri","absorber","abwickeln","accepters","accorciare","acephalous","acidosis","acquisitively","actualizado","addicts","adictarse","admirado","adrenocorticotropin","adverbially","afficher","afinar","ageism","agile-legged","agraviar","ailments","aiutante","alcohol-attributable","algo","alkalize","allergy-inducing","allurements","alternative","amateurishly","amenably","amoralism","amusingly","anbieten","angelically","animal-borne","annihilating","anpinnen","anthemis","anti-democratic","anti-reader","antiderivative","antisepsis","apaciguar","aplaciblemente","apparente","applicably","approach-independent","aprisa","arare","archer","archive","aridly","aromatizing","arrogance","artificially-induced","asesinar","asphyxiated","assertive-looking","assistively","astonishing","atenerse","atrasado","attenuante","attunement","aufpassen","ausencia","authenticatable","autological","available","avisado","aweary","back-end","backwoods","baking","ballet-zealous","bankruptcy","barkentine","basely","battery-caged","beard","bedlam","befit","beheading","belladonna","beneficiality","beres","beschwichtigen","betray","biasanya","bigger","binding","biotechnology","bite-sized","blamable","blender","blood-consuming","blue-violet","boatswain","bolus","bookable","borderer","bottom-floor","bowwow","brakeman","bray","breezes","brinde","brokenly","bruit","budget-minded","bullfight","bureaucracy-driven","bushy","button-controlled","cachou","calcination","calm","campaigner","capsulation","carbon-rich","caricaturally","carousel","casserole","catches","cautamente","celebratorily","centi-","centrifugal","cert","challengeability","chaos","chapter","chastisement","cheesy","chiaro","chowder","chum","churchmen","circulation-enhancing","citrous","clandestino","classmate","cleavable","climate-vulnerable","close-fitting","clownishness","co-workers","coats","codified","coliseum","colluding","columnist","comico","commiserate","community-focused","comparire","competitiveness","complicatamente","comprendere","comrades","concertina","concur","conduire","confined","confrere","congruent","conocer","conservador","consolidar-se","constructible","containable","contention-based","contra-","contribuir","convenient","convinto","coperto","cordovan","corporate-operated","corroborated","cosmetic","couch","countermissile","couture","crackdown","crawling","credit-funded","crier","crochet","cross-post","crucciarsi","cryogenic-resistant","cuidadoso","cunning","currish","customer-centricity","cyclically","dahingegangen","dankbar","data-frugal","daytime-inspired","de-urbanize","debut","decently","declinable","deconstructivism","dedication","defeating","deficit-reduced","defraudar","dehumanizing","delegating","delirious","demerit","demoralizer","denormalization","depend","deporre","deracinated","desastrado","desconocedor","desencadear","desfogarse","desinteresar","desolado","desprecintar","destructible","detenere","detractor","device","diabetes-free","dibagi","dietitian","digested","dildo","dimple","directing","disaffecting","disbandment","disconnectable","discriminate","disfare","dishware","diskusi","disparage","disposizione","dissatisfied","dissuading","distorting","dither","divine","doctrinairism","dolere","donee","dote","dove-grey","downy-haired","dram","drawstring","drivel","drum-focused","ductless","dunking","duteous","e-ready","earthmoving","eccedenza","economizzare","edulcorante","effort-based","eigenartig","ekelhaft","electrocardiograph","elfish","emanare","embed","embodiment","emissivity","employ","emptying","encephalopathic","end-of-roll","endure","enfermizo","engravings","ennoblishing","entbunden","entitle","entryway","environmentally-destructive","epistrophe","equipo","ergriffen","erringen","escalation","esile","esquiver","estimar","etcher","europium","evenly-sized","exasperate","excitatory","execrated","exhibitable","exorbitance","expendable","explainable","exposingly","extendida","extra-atomic","extremist","fa","factitious","fair-weather","falsifying","fantastisch","fassungslos","fatigar","fearfully","feedback","felted","ferocious","fidelity","filial","financiers","fire-lit","fishbowl","fizz","flange","flaunt","flexible hours","floodlights","fluctuate","flux","foiling","foolery","forcefulness","foreseen","form-based","fornire","fossa","fowl","fragrant","frecuentador","freiwillig","frier","frontrunner","frustrato","full-strength","funeral","fusee","gainful","gaming-related","garnish","gathering","gehaltvoll","gender-unequal","genomic","geometrically","geschmacklos","giubilantemente","gleamed","glorified","goal-driven","gonad","gotten","gradito","granny","grato","greasy-haired","griddlecake","grooving","growing","guardedly","gullibly","gymnastically","hackwork","half-dozen","hamburger","handpick","hard-featured","haziness","health-unconscious","heat-retaining","heft","helps","here-and-now","hesitant","hickory","high-lofted","highfaluting","hintersinnig","hoarhound","holist","hommes","honor","hormonology","hospitalario","houseman","human-friendly","hummock","hutch","hydrous","hypersensitive","hypothecate","iconolatry","idleness","ilex","illogico","immettersi","immunopotentiating","impeccably","impertinent","implosion","impractical","improvement-oriented","in-stater","inaptitude","incastrarsi","inclinarsi","incompetent-looking","inconvenablement","inculcated","indemnification","indifferenza","indite","indugiare","inefficientemente","inexpensiveness","inferior","inflation-hedging","informational","ingestion","inhibitingly","injustice","innocuous-appearing","inquietante","insediarsi","insipid","installer","instrumentalization","intacto","intendere","interchangeable","interim","internally-supported","interschool","intonate","intrecciare","inundate","investigate","invoice","iron-gray","irreligiosidad","irritar","isotope","jackrock","jazz","jiggly","jollity","juice","jut-jawed","keberagaman","kelaparan","kesegaran","kewaspadaan","kindergarteners","klobig","knuckle","korrekt","labor-managed","lactic","lamentableness","landsman","larron","lauding","lay","leaf-shaped","lebend","legalism","lemma","lesson","liability","licentiously","ligand-activated","lightweight-looking","limonite","lionhearted","listing","liveliness","lobsterpot","loftier","long-sleeved","lovable","low-permeability","lowlights","lumbering","machinate","madrugar","maiden","maladroitness","malice","mammectomy","mandrake","many","marinating","marquess","mass-market","materiality","mauve-blue","meanly","mediator","megillah","memahami","memoranda","memprediksi","menganggur","menor","mercantilist","mescaline","metal-look","meticoloso","microcrystal","midshipman","milk-fed","mind-numbing","ministering","misanthropic","misericordioso","misplacing","mistune","mobbing","modernize","moisture-sensitive","monedas","monoculturalist","monosomatic","moorage","mortgage","motive","mouthwash","muffledly","multi-racial","multimillionaire","mumps","musically","muzzled","nahezu","narcotism","nationhood","navigators","nectareous","neighborly","nettle","never","nicotine-added","noblest","non-DNA-associated","non-addictive","non-attributable","non-circular","non-consenting","non-degeneration","non-elastic","non-favorite","non-governmental","non-interacting","non-lobed","non-moralizing","non-painful","non-prehensile","non-reentrant","non-salaried","non-socialist","non-symmetric","non-vector-borne","nonbleeding","nonethnic","nonmorally","nonskid","normative","noticeability","nuclease","nut","obbligare","obligare","observatory","ocasionalmente","oculist","off-gas","offish","oilcan","oltretutto","oncolytic","onrushing","openwork","oportunista","optimization-blocking","ordentlich","organizzarsi","orogenesis","ostentar","ousted","outfall","outraging","over-attentively","overbooked","overemployment","overline","overripe","overtook","oxidizer-rich","pacifying","painful","palmetto","panoply","paraded","parathion","parlare","participial","pass","patcher","patron","peace-building","pedantic","pejoratively","pengambilan","penyembunyian","perdebatan","perfume-related","perjure","perplex","personnel-independent","pervenuto","petition","petrol-powered","phenomena","phosphoric","phrenic","picnicker","pigpen","pine","pista","placekick","planificar","plauderhaft","plena","plumbing","poem","policing","polyester","poncho","popgun","porticoed","possibly","postnatal","potsherd","ppm","pre-configuration","preceded","predestined","preheat","preoccupy","prescrire","pressure-operated","prevalentemente","priesthood","priority","pro-Westernism","proativamente","procoagulant","productivity-centered","profit-orientedly","progressives","prometedor","promised","proofs","proppen","prostrate","protocol-exploitable","provider-centric","pruritic","public-influenced","pugnacious","pungent","purificatory","putrefy","quadru-","quarters","quibbling","quittance","rack-mountable","radiographer","railfan","ramshackle","raptly","rational","razonabilidad","re-embark","re-let","reaccommodation","real-looking","rearming","rebranded","receptionist","reclaim","reconcile","recovery","recyclables","redly","reeds","reflationist","refueling","regionalization","regulo","reinsman","relacionados","relevant","remarkable","remote-unfriendly","renounce","repayable","replica","reprint","repurpose","research-driven","resigned","resource-based","restricted-color","retaliating","retransfusion","reuse","reversing","revolutionize","rhythmical","rickshaw","rifiutato","riot","risk-insensitive","rivalrous","robust-looking","rolling","rosewood","round","rubbish bin","ruinously","rurality","saciedad","sagacious-looking","salida","salve-like","sangat","satiable","savoriness","scallopini","scatterbrain","schierarsi","schuldig","scompigliatamente","scoured","script-like","scurvy-affected","sect","sedikit","segregarsi","selesai","self-conscious","self-examining","self-knowledge","self-regulation","selisih","semitropical","sensitive-skinned","seperti","serially","sessionable","sexism","shade-dependent","shame","shaved","shiftily","shiveringly","short-stemmed","shrapnel","sialorrhea","siempre","silent","simoom","singalong","single-step","sipping","skateboarder","skin","slag","sleepshirt","slithery","slumberous","smearable","smoothbore","snap-on","snowball","sobresalir","sofort","solaparse","solidness","somigliare","sopping","soutenir","spade","spaventare","specter","spending-oriented","spin-dried","splendente","spopolarsi","spreco","squalidly","sradicarsi","stagger","stand-alone","starling","stationing","steeplechase","sterilizer","stimolato","stockjobber","storage","straightened","stratosphere","stressing","stroll-loving","stuck-up","sturdier","subdivision","submersibility","substance","suburb","sudorific","suits","sun-affected","sunstroke","superlight","supplicatingly","surcharge","surrender","sustentarse","swat","swindler","symbolization","synthesized","tabulation","taire","tameness","tardar","tattoo","teamwork","technology-centered","telamon","temeroso","tender","teratology","terrier","tetragonal","thematize","thermo-activated","thine","thread-like","thrombus","tideless","timbrel","tingersi","toilsomely","tonificare","topology-unaware","totaled","tournament","tractably","traidor","transaction","transient","transpire","trattoria","tree-like","triangulation","trimaran","trivium","trudge","tuberculosis-related","tunneled","tussock","two-chamber","typewriter-like","ultra-","unaffectionate","unapproachability","unauthentic","unberthing","unbuildable","unchristian","uncommunicated","unconsumables","uncriticizable","under-fertilize","underdevelopment","underloading","undershoot","undeserving","undramatically","unearthed","unendurably","unexchangeability","unfazed","unforeseenly","ungemein","unhappiness","unimpaired","unintelligibly","unit-dependent","unlabialized","unloved-looking","unmethylated","unnoticedly","unpartitioned","unpollutedly","unprophetic","unreason","unreliable-looking","unrestrained","unsalvageability","unseen","unsingable","unspreadable","unsuitably","untaxed","untoned","unutterability","unweeded","unzutreffend","uprightly","urbanology","usurper","vacillating","validity","vanquish","varying","vehicle-reliant","vengeance","verbannen","verifiable","vernacular","verraten","vertreiben","vexingly","video-compatible","villainy","viridity","visual-related","vocal","voler","vorgeblich","vullen","waiting","warble","washout","water-resistance","waxlike","weary-eyed","weeper","weld","well-off-looking","westerly","whensoever","white-capped","whosever","wild-type","windchill","wintertide","withholder","womanizer","wooer","workflow","worseners","wringer","yachting","yesteryear","zealously","zoologist"]

let localDictionary = {}

function nearestIndex(key) {
    let left = -1;
    let right = index.length;
    while (right - left > 1) {
        const mid = Math.floor(left + (right - left) / 2);
        if (index[mid] > key) {
	    right = mid;
	} else {
	    left = mid;
	}
    }
    return index[left];
}

const template = fetch('/word.mustache')
      .then(response => {
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
      })
      .then(templateString => {
          return Hogan.compile(templateString);
      })
      .catch(error => {
          console.error('failed to load template', error);
      });

function parseMarkdownBold(text) {
    return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

const render = async (data, template) => {
    data.readability_explanation.text = parseMarkdownBold(data.readability_explanation.text);
    data.usage_notes.explanation = parseMarkdownBold(data.usage_notes.explanation)
    return (await template).render(data);
}

const performSearch = (resultsContainer) => {
    const searchTerm = searchInput.value.trim();
    performSearchImpl(searchTerm, resultsContainer);

    const newUrl = '/?query=' + searchTerm;
    history.pushState({
	query: searchTerm
    }, '', newUrl);
}

const updateContainer = async (word) => {
    const resultsContainer = document.getElementById('results');
    if (localDictionary[word]) {
	const data = localDictionary[word];
        const output = await render(data, template);
        resultsContainer.innerHTML = output;
    } else {
        resultsContainer.innerHTML = '<p>‰∏ÄËá¥„Åô„ÇãÂçòË™û„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>';
    }
}

const performSearchImpl = async (searchTerm) => {
    if (searchTerm === '') {
        resultsContainer.innerHTML = '<p>Ê§úÁ¥¢ÂçòË™û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
        return;
    }
    const file = nearestIndex(searchTerm) + ".json.lz"
    const requestUrl = `/${file}`

    if (localDictionary[searchTerm]) {
	updateContainer(searchTerm);
	return;
    }

    try {
        const response = await fetch(requestUrl, {
            method: 'GET',
            headers: {
                'Accept-Encoding': 'br'
            }
        });
	const ds = new DecompressionStream("deflate");

	const readableStream = response.body;
	const decompressedStream = readableStream.pipeThrough(ds);
	const blob = await new Response(decompressedStream).blob();
	const dict = JSON.parse(await blob.text());

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
	localDictionary = { ...localDictionary, ...dict };
	updateContainer(searchTerm)
    } catch (error) {
        console.error('Error fetching dictionary data:', error);
    }
};

function load() {
    const searchButton = document.getElementById('searchButton');
    searchButton.addEventListener('click', () => {
	performSearch()
    });
    
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            performSearch();
        }
    });
    
    const params = new URLSearchParams(window.location.search);
    const query = params.get('query');
    searchInput.value = query;
    performSearchImpl(query);
};

window.addEventListener('pageshow', async (event) => {
    // event.persisted „Åå true „Å™„Çâ bfcache „Åã„ÇâÂæ©ÂÖÉ„Åï„Çå„Åü
    // false „Å™„ÇâÈÄöÂ∏∏„ÅÆ„Éö„Éº„Ç∏„É≠„Éº„Éâ
    console.log('pageshow event fired. persisted:', event.persisted);
    
    // bfcache„Åã„ÇâÂæ©ÂÖÉ„Åï„Çå„ÅüÂ†¥Âêà„Åß„ÇÇ„ÄÅURL„Éë„É©„É°„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Å¶UI„ÇíÂÜçÂàùÊúüÂåñ„Åô„Çã
    // Áä∂ÊÖã„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅpopstate„Ç§„Éô„É≥„Éà„ÅßÂá¶ÁêÜ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ
    // „Åì„Åì„Åß„ÅØÂº∑Âà∂ÁöÑ„Å´UI„ÇíURL„Åã„ÇâÂæ©ÂÖÉ„Åô„Çã„ÄÇ
    load();
});

window.addEventListener('popstate', async (event) => {
    console.log("popstate event fired. state:", event.state);
    // popstate„ÅØÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´Áô∫ÁÅ´„Åô„Çã
    // bfcache„Åã„Çâ„ÅÆÂæ©ÂÖÉÊôÇ„Å´„ÇÇÁô∫ÁÅ´„Åó„ÅÜ„Çã„Åå„ÄÅpageshow„Å®„ÅÆÂΩπÂâ≤ÂàÜÊãÖ„ÇíÊòéÁ¢∫„Å´„Åô„Çã
    // „Åì„Åì„Åß„ÅØUI„ÅÆÊõ¥Êñ∞„ÇíinitializePageFromUrl„Å´‰ªª„Åõ„ÄÅ
    // popstate„ÅØ‰∏ª„Å´„Ç§„Éô„É≥„Éà„ÅÆÊ§úÁü•„Å®„É≠„Ç∞„Å´Áïô„ÇÅ„Çã„Åã„ÄÅ
    // ÁâπÂÆö„ÅÆstate„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰Ωø„Å£„Åü„Çà„ÇäË©≥Á¥∞„Å™Âæ©ÂÖÉÂá¶ÁêÜ„ÇíË°å„ÅÜ„ÄÇ
    // ‰ªäÂõû„ÅÆ„Ç±„Éº„Çπ„Åß„ÅØinitializePageFromUrl„ÅåURL„Åã„ÇâÂæ©ÂÖÉ„Åô„Çã„ÅÆ„Åß„ÄÅ
    // popstate„ÅßÁâπÂà•„Å™stateÂá¶ÁêÜ„ÅØÂøÖÈ†à„Åß„ÅØ„Å™„ÅÑ„ÄÇ
    // „Åó„Åã„Åó„ÄÅ„Çà„ÇäË§áÈõë„Å™Áä∂ÊÖãÁÆ°ÁêÜ„ÅÆÂ†¥Âêà„ÅØevent.state„ÇíÁõ¥Êé•Âà©Áî®„Åô„Çã„ÅÆ„ÅåËâØ„ÅÑ„ÄÇ
    // ‰æã„Åà„Å∞„ÄÅevent.state„Å´Áõ¥Ââç„ÅÆÊ§úÁ¥¢Êù°‰ª∂„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„Å™„Å©„ÄÇ
    if (event.state) {
        // history.pushState„Åß‰øùÂ≠ò„Åó„Åüstate„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂà©Áî®„Åó„Å¶Âæ©ÂÖÉ
        const query = event.state.query || '';
	searchInput.value = query;
        performSearchImpl(query);
    } else {
        load();
    }
});
